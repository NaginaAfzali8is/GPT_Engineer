<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Project</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0; 
        }

        h1 {
            text-align: center;
            margin-top: 20px;
        }

        form {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        label {
            font-weight: bold;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
        }

        input[type="submit"] {
            background-color: #4caf50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        input[type="submit"]:hover {
            background-color: #45a049;
        }

        .download-btn {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
/* Styling for the download button */
.download-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 24px;
    background-color: #4CAF50;
    color: #fff;
    text-decoration: none;
    border-radius: 8px;
    transition: background-color 0.3s, transform 0.2s;
    font-size: 16px;
}

.download-button:hover {
    background-color: #45a049;
    transform: translateY(-2px);
}

/* Styling for the SVG icon */
.download-button svg {
    margin-left: 8px;
    width: 20px;
    height: 20px;
}
/* Styling for the file name */
.file-name {
    font-weight: bold;
    color: #007bff; /* Blue color for highlighting */
}

/* Styling for the API cost */
.api-cost {
    color: #333; /* Dark gray color */
}

/* Styling for the success message */
.success-message {
    color: #4CAF50; /* Green color */
}
    </style>
</head>
<body>
    <h1>GPT Engineer</h1>
    <form id="openaiForm">
        <label for="openai_key">OpenAI API Key:</label><br>
        <input type="text" id="openai_key" name="openai_key" required><br>

        <label for="project_type">Project Name:</label><br>
        <input type="text" id="project_type" name="project_type" required><br>

        <label for="project_description">Project Description:</label><br>
        <textarea id="project_description" name="project_description" rows="4" cols="50" required></textarea><br>

        <input type="submit" value="Submit">
    </form>
    <div id="user-data-container">
        <!-- User data will be populated here -->
    </div>
    <div class="download-btn" id="download-message" style="display: none;">
        <p id="success-message" class="success-message">Your project has been created successfully. Click the button below to download it.</p>

        <div>
            <!-- Enhanced download button -->
            <!-- <a href="/download" id="download-link" class="download-button"> -->
                <a href="#" id="download-link" class="download-button" onclick="downloadFile(null)">
                    
                <span id="file-name">Download File</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-download">
                    <polyline points="8 17 12 21 16 17"></polyline>
                    <line x1="12" y1="12" x2="12" y2="21"></line>
                    <line x1="7" y1="7" x2="17" y2="7"></line>
                </svg>
            </a>
        </div>
    </div>
    
    
        <script>
            var projectElement;
            function downloadFile(filename) {
                // If there's no filename provided, extract it from the span element
if (!filename) {
    filename = document.getElementById("file-name").innerText;
}

// Check if the filename has a .zip extension, if not, add it
if (!filename.endsWith('.zip')) {
    filename += '.zip';
}

// Create a temporary anchor element
var downloadAnchor = document.createElement('a');
downloadAnchor.setAttribute('href', '/download?filename=' + encodeURIComponent(filename));
downloadAnchor.setAttribute('download', filename);

        // Programmatically trigger a click on the anchor element
        downloadAnchor.click();
    }
               // This code runs when the DOM content is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Retrieve the openai_key from localStorage
        let openai_key = localStorage.getItem('openai_key');
        
        // Check if the openai_key exists in localStorage
        if (openai_key) {
           oldProjects(openai_key)
        } else {
            // The openai_key does not exist in localStorage
            console.log('openai_key not found in localStorage');
        }
    });

            let file_name;
            // Construct the download URL using the file name
            let downloadUrl;

            document.getElementById("openaiForm").addEventListener("submit", function (event) {
                event.preventDefault();

                // Get form data
                const formData = new FormData(event.target);
                 // Extract the value of the openai_key input field
                const openai_key = formData.get('openai_key');
                
                // Save openai_key key in localStorage
                localStorage.setItem('openai_key', openai_key);
                console.log(event.target, "form fields");
                // Make API call
                fetch("/setup_openai_key", {
                    method: "POST",
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json(); // Parse JSON response
                    })
                    .then(data => {
                        if(data.success){
                            oldProjects(openai_key)
        document.getElementById('download-message').style.display = 'block';
        document.getElementById('file-name').innerHTML = data.file_name;

                        }
                        // Access file name and API cost directly from JSON data
                         file_name = data.file_name;

                        // Do something with the file name and API cost
                        console.log('File Name:', file_name);
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
            });

            function oldProjects(openai_key){

    // Fetching data from the API using GET method
    return fetch('/user?openai_key=' + openai_key)
    .then(response => response.json())
                .then(data => {
                    // Update the page content with user data
                    updateUserContent(data);
                })
        .catch(error => {
            console.error('There was a problem with your fetch operation:', error);
        });
}
// Function to update the page content with user data
function updateUserContent(data) {
            var userDataContainer = document.getElementById('user-data-container');
            if (data && data.project_name) {
                // Clear existing content
                userDataContainer.innerHTML = '';

                // Add user data to the page
                var projects = data.project_name;
                projects.forEach(project => {
                    projectElement = document.createElement('p');
                    projectElement.textContent = project;
                    userDataContainer.appendChild(projectElement);
                    // Attach click event listener to trigger download
            projectElement.addEventListener('click', function() {
                var projectName = projectElement.textContent;
                console.log(projectName,"projectname");
                downloadFile(projectName);
            });
                });
            } else {
                // Handle case where no data is available
                userDataContainer.textContent = 'No data available';
            }
        }
        // Attach click event listener to trigger download
        // projectElement.addEventListener('click', function() {
        //     console.log(projectElement);
        //         downloadFile(project);
        //     });
            // Add event listener for the download button click
// document.getElementById('download-buttonn').addEventListener('click', function() {
//     // Extract filename
//     console.log();
//     const fileName = document.getElementById('file-name').textContent;

//     // Construct the download URL
//     const downloadUrl = `/projectsZip/${encodeURIComponent(file_name)}`;

//     // Create a temporary link element
//     const a = document.createElement('a');
//     a.href = downloadUrl;
//     a.download = file_name;

//     // Append link to the body and trigger download
//     document.body.appendChild(a);
//     a.click();

//     // Cleanup
//     document.body.removeChild(a);
// });

// Add event listener for the download button click
// document.getElementById('download-button').addEventListener('click', function() {
//     // Extract filename

//     // Call the download API
//     fetch(`/download`, {
//         method: 'GET',
//         headers: {
//             'Content-Type': 'application/json'
//             // Add any other headers if required
//         }
//     })
//     .then(response => {
//         if (!response.ok) {
//             throw new Error('Network response was not ok');
//         }
//         alert("file downloaded successfully")
//         // Initiate download
//         return response.blob();
//     })
//     .catch(error => {
//         console.error('Error:', error);
//     });
// });

        </script>

    <script>
        debugger
        // Show the download message after project creation
        // window.onload = function() {
        //     var success = "{{ success }}";
        //     if (success == "True") {
        //         document.getElementById('file-name').innerHTML = "{{ file_name }}";
        //         document.getElementById('download-message').style.display = 'block';
        //     }
        // };
    
        // // Attach click event handler to the download button
        // document.getElementById('download-link').addEventListener('click', function() {
        //     // Redirect to the download URL
        //     window.location.href = "{{ download_url }}";
        // });
    </script>
    
</body>
</html>
